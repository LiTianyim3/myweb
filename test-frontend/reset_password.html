<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>重置密码</title>
  <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
  <div class="container">
    <div class="form-container">
      <h1>重置密码</h1>

      <!-- 第一步：输入邮箱获取验证码 -->
      <form id="step1-form" autocomplete="off">
        <div id="msg1" class="error-message"></div>
        <div class="form-group">
          <label for="email-reset">注册邮箱</label>
          <input type="email"
                 id="email-reset"
                 class="form-control"
                 placeholder="请输入邮箱"
                 autocomplete="off"
                 required>
        </div>
        <div class="form-group">
          <button id="send-code-btn" class="btn btn-primary">发送验证码</button>
        </div>
      </form>

      <!-- 第二步：输入验证码和新密码 -->
      <form id="step2-form" style="display:none;" autocomplete="off">
        <div id="msg2" class="error-message"></div>
        <div class="form-group">
          <label for="code-reset">验证码</label>
          <input type="text"
                 id="code-reset"
                 class="form-control"
                 placeholder="请输入验证码"
                 autocomplete="one-time-code"
                 required>
        </div>
        <div class="form-group">
          <label for="new-password">新密码</label>
          <input type="password"
                 id="new-password"
                 class="form-control"
                 placeholder="请输入新密码"
                 autocomplete="new-password"
                 required>
        </div>
        <div class="form-group">
          <label for="confirm-new">确认新密码</label>
          <input type="password"
                 id="confirm-new"
                 class="form-control"
                 placeholder="请再次输入新密码"
                 autocomplete="new-password"
                 required>
        </div>
        <div class="form-group">
          <button id="reset-btn" class="btn btn-primary">重置密码</button>
        </div>
      </form>

      <div class="form-group text-center">
        <p><a href="index.html">返回登录</a></p>
      </div>
    </div>
  </div>

  <script>
    // 发送验证码
    let countdown = 0;
    let timer = null;
    document.getElementById('send-code-btn').onclick = function(e) {
      e.preventDefault();
      if (countdown > 0) return;
      const email = document.getElementById('email-reset').value.trim();
      const msg1 = document.getElementById('msg1');
      msg1.textContent = '';
      if (!email) {
        msg1.textContent = '请输入邮箱';
        return;
      }
      fetch('http://localhost:5000/api/reset-password/send-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          startCountdown();
          document.getElementById('step1-form').style.display = 'none';
          document.getElementById('step2-form').style.display = '';
        } else {
          msg1.textContent = data.message || '发送失败';
        }
      })
      .catch(() => {
        msg1.textContent = '网络错误，请稍后重试';
      });
    };
    // 倒计时函数
    function startCountdown() {
      countdown = 60;
      updateCountdown();
      timer = setInterval(() => {
        countdown--;
        updateCountdown();
        if (countdown <= 0) {
          clearInterval(timer);
        }
      }, 1000);
    }
    function updateCountdown() {
      const msg2 = document.getElementById('msg2');
      if (countdown > 0) {
        msg2.textContent = `请在${countdown}秒内填写验证码，否则需重新获取`;
      } else {
        msg2.textContent = '验证码已失效，请重新获取';
      }
    }
    // 重置密码
    document.getElementById('reset-btn').onclick = function(e) {
      e.preventDefault();
      const email = document.getElementById('email-reset').value.trim();
      const code = document.getElementById('code-reset').value.trim();
      const newPassword = document.getElementById('new-password').value;
      const confirmNew = document.getElementById('confirm-new').value;
      const msg2 = document.getElementById('msg2');
      msg2.textContent = '';
      if (!code || !newPassword) {
        msg2.textContent = '请填写所有字段';
        return;
      }
      if (newPassword !== confirmNew) {
        msg2.textContent = '两次输入的新密码不一致';
        return;
      }
      fetch('http://localhost:5000/api/reset-password/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, code, new_password: newPassword })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('密码重置成功，请登录');
          window.location.href = 'index.html';
        } else {
          msg2.textContent = data.message || '重置失败';
        }
      })
      .catch(() => {
        msg2.textContent = '网络错误，请稍后重试';
      });
    };
  </script>
</body>
</html>